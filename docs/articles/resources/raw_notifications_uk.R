## sourced from https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/464852/TB_case_notifications_1913_to_2014.pdf
Raw.PHE.Notifications <-  c(1913, 80788, 36351, 117139,
                            1914, 76109, 23388, 99497,
                            1915, 68309, 22283, 90592,
                            1916, 68109, 22799, 90908,
                            1917, 68801, 20884, 89685,
                            1918, 71631, 18942, 90573,
                            1919, 61154, 16357, 77511,
                            1920, 57844, 15488, 73332,
                            1921, 56334, 15368, 71702,
                            1922, 53422, 15837, 69259,
                            1923, 57007, 18494, 75501,
                            1924, 57737, 18711, 76448,
                            1925, 58545, 19228, 77773,
                            1926, 56212, 18608, 74820,
                            1927, 54048, 17697, 71745,
                            1928, 53047, 17977, 71024,
                            1929, 52634, 16544, 69178,
                            1930, 50583, 16818, 67401,
                            1931, 49798, 16084, 65882,
                            1932, 46579, 15499, 62078,
                            1933, 44482, 14095, 58577,
                            1934, 43034, 13694, 56728,
                            1935, 39635, 12435, 52070,
                            1936, 39336, 12268, 51604,
                            1937, 39630, 12661, 52291,
                            1938, 37879, 12810, 50689,
                            1939, 34930, 11275, 46205,
                            1940, 36151, 10421, 46572,
                            1941, 39499, 11465, 50964,
                            1942, 40629, 11990, 52619,
                            1943, 42410, 11932, 54342,
                            1944, 43794, 10519, 54313,
                            1945, 42165, 9944, 52109,
                            1946, 42173, 9116, 51289,
                            1947, 43159, 8566, 51725,
                            1948, 43971, 8605, 52576,
                            1949, 44480, 7561, 52041,
                            1950, 42435, 6923, 49358,
                            1951, 42695, 6744, 49439,
                            1952, 41904, 6189, 48093,
                            1953, 40917, 5629, 46546,
                            1954, 36973, 5375, 42348,
                            1955, 33580, 4554, 38134,
                            1956, 31342, 4162, 35504,
                            1957, 28870, 3799, 32669,
                            1958, 26391, 3447, 29838,
                            1959, 24280, 2820, 27100,
                            1960, 20799, 2806, 23605,
                            1961, 19051, 2696, 21747,
                            1962, 17845, 2674, 20519,
                            1963, 16348, 2589, 18937,
                            1964, 15019, 2580, 17599,
                            1965, 13552, 2551, 16103,
                            1966, 12355, 2246, 14601,
                            1967, 11023, 2183, 13206,
                            1968, 10681, 2273, 12954,
                            1969, 9675, 2490, 12165,
                            1970, 9475, 2426, 11901,
                            1971, 9119, 2578, 11697,
                            1972, 8689, 2384, 11073,
                            1973, 8710, 2446, 11156,
                            1974, 8102, 2575, 10677,
                            1975, 8208, 2610, 10818,
                            1976, 7712, 2386, 10098,
                            1977, 7121, 2399, 9520,
                            1978, 7708, 2604, 10312,
                            1979, 6807, 2459, 9266,
                            1980, 6670, 2472, 9142,
                            1981, 5859, 2269, 8128,
                            1982, 5466, 1944, 7410,
                            1983, 4880, 1923, 6803,
                            1984, 4535, 1606, 6141,
                            1985, 4293, 1564, 5857,
                            1986, 4345, 1648, 5993,
                            1987, 3640, 1446, 5086,
                            1988, 3675, 1489, 5164,
                            1989, 3816, 1616, 5432,
                            1990, 3618, 1586, 5204,
                            1991, 3596, 1840, 5436,
                            1992, 3816, 1983, 5799,
                            1993, 3961, 1960, 5921,
                            1994, 3694, 1897, 5591,
                            1995, 3711, 1897, 5608,
                            1996, 3690, 1964, 5654,
                            1997, 3947, 1912, 5859,
                            1998, 3926, 2161, 6087,
                            1999, 3827, 2317, 6144,
                            2000, 3695, 2530, 6225,
                            2001, 3744, 2606, 6350,
                            2002, 4128, 2692, 6820,
                            2003, 4025, 2758, 6783,
                            2004, 4128, 2969, 7097,
                            2005, 4436, 3383, 7819,
                            2006, 4409, 3431, 7840,
                            2007, 4278, 3477, 7755,
                            2008, 4382, 3536, 7918,
                            2009, 4534, 3735, 8269,
                            2010, 4162, 3635, 7797,
                            2011, 4356, 4012, 8368,
                            2012, 4266, 3917, 8183,
                            2013, 3796, 3572, 7368,
                            2014, 3499, 3108, 6607)


PHE.Notifications <- t(matrix(Raw.PHE.Notifications, 4, length(Raw.PHE.Notifications)/4))
PHE.Notifications <- PHE.Notifications[,-1]
  colnames(PHE.Notifications) <- c('Pulmonary', 'Extra-Pulmonary', 'Total')

Data.Start <- 1913
rownames(PHE.Notifications) <- as.character(sapply(1:nrow(PHE.Notifications), function(i) { M <- Data.Start+i-1 }) ) 
 
prop_with_CI_df <- function(i, df){ 
  M <- map(1:ncol(df), function(j){
    if (df[i,j] <= df[i-1,j])
    {
      p <- df[i,j]
      n <- df[i-1,j]
    }else{
      p <- df[i-1,j]
      n <- df[i,j]
    }
    M <- prop.test(p,n)
    
    ## standard deviation from poportion estimate
    SD_prop <- sqrt(((1- M$estimate)*M$estimate)) 
    
    ## standard deviation from confidence intervals
    LCI <- M$conf.int[1]
    UCI <- M$conf.int[2]
    SD_CI <- sqrt(n)*(UCI-LCI)/(2*qnorm(0.975))
    if(abs(SD_prop - SD_CI) >= 1e-1) warning(paste0('Standard deviation estimates differ at', i,' and ', j, ' with SD_prop=', SD_prop, ' and SD_CI', SD_CI ))
    SD <- max(SD_prop, SD_CI)
    
    if (df[i,j] <= df[i-1,j]){
      prop <- 1-M$estimate
      LCI <- 1- LCI
      UCI <- 1- UCI
    }else{
      prop <-  M$estimate -1
      LCI <- LCI - 1
      UCI <- UCI - 1
    }
    return(list(prop,SD, LCI, UCI))
  })
  return(M)}

Prop_TB_uk <- map(2:nrow(PHE.Notifications), function(i) prop_with_CI_df(i, df=PHE.Notifications)) %>% flatten %>% transpose %>% map(function(x) matrix(unlist(x),ncol=3, byrow=TRUE)) 

lapply(1:length(Prop_TB_uk), function(i){ 
  rownames(Prop_TB_uk[[i]]) <<- rownames(PHE.Notifications)[-1]
  colnames(Prop_TB_uk[[i]]) <<- colnames(PHE.Notifications)
  return(NULL)})

names(Prop_TB_uk) <- c('proportion', 'sd','LCI', 'UCI')
