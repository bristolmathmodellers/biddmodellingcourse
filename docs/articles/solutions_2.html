<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solutions 2: Compartmental Models to Equations â€¢ BIDD Modelling Course</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Solutions 2: Compartmental Models to Equations">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">biddmodellingcourse</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Practicals
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/practical_1.html">Practical 1 - Designing a Model</a>
    </li>
    <li>
      <a href="../articles/practical_2.html">Practical 2 - Compartmental Models to Equations</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Solutions
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/solutions_1.html">Solutions 1 - Designing a Model</a>
    </li>
    <li>
      <a href="../articles/solutions_2.html">Solutions 2 - Compartmental Models to Equations</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Fact Sheets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tb_fact_sheet.html">Tuberculosis</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://www.seabbs.co.uk/shiny/exploreidmodels/">Explore ID Models Interactively</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/bristolmathmodellers/biddmodellingcourse/">
    <span class="fa fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Solutions 2: Compartmental Models to Equations</h1>
                        <h4 class="author">Sam Abbott</h4>
            
          </div>

    
    
<div class="contents">
<div id="learning-objectives" class="section level1">
<h1 class="hasAnchor">
<a href="#learning-objectives" class="anchor"></a>Learning Objectives</h1>
<ol style="list-style-type: decimal">
<li>Know how to translate a simple model flow diagram into equations.</li>
<li>Understand how changing parameter values can change model dynamics.</li>
<li>Extension: Know how to use a simple model scaffold to develop a more complex model.</li>
</ol>
</div>
<div id="outline-for-session" class="section level1">
<h1 class="hasAnchor">
<a href="#outline-for-session" class="anchor"></a>Outline for Session</h1>
<ol style="list-style-type: decimal">
<li>Set up (5 minutes)</li>
<li>Explore the dynamics of a simple SEIR model (20 minutes)</li>
<li>Extension exercises, to be completed in any order/combination;
<ol style="list-style-type: decimal">
<li>Explore the parameter space of multiple models using a web interface (25 minutes) (<em>not R based</em>).</li>
<li>Add high and low risk latency to a SEIR model, and explore this models dynamics in comparison to the SEIR model (25 minutes) (<em>R based</em>).</li>
<li>Translate a more realistic SHLIR model flow diagram to equations (25 minutes)(<em>this excercise involves implementing a complex model in R</em>).</li>
</ol>
</li>
<li>Session wrap up (5 minutes)</li>
</ol>
</div>
<div id="exercise" class="section level1">
<h1 class="hasAnchor">
<a href="#exercise" class="anchor"></a>Exercise</h1>
<div id="a-simple-seir-model-of-tuberculosis-tb" class="section level2">
<h2 class="hasAnchor">
<a href="#a-simple-seir-model-of-tuberculosis-tb" class="anchor"></a>1. A Simple SEIR Model of Tuberculosis (TB)</h2>
<p>As a first exercise we are going to run the simple SEIR model, as seen in the design a model practical, in R. As a first step you will need to load the following packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(biddmodellingcourse)
<span class="kw">library</span>(knitr)
<span class="kw">library</span>(prettypublisher)</code></pre></div>
<p>For reference the SEIR model flow diagram (<span class="citation">[1]</span>) seen in the first practicals solutions. The equations below are a translation of this into <code>R</code> code.</p>
<div class="figure">
<img src="resources/SEIR_flow_diag.png" alt="Figure 1: An SEIR model of TB transmission, including simple demographic processes"><p class="caption">Figure 1: An SEIR model of TB transmission, including simple demographic processes</p>
</div>
<div id="populations-and-initialisation" class="section level3">
<h3 class="hasAnchor">
<a href="#populations-and-initialisation" class="anchor"></a>Populations and Initialisation</h3>
<p>We first set up the initial populations for the Susceptible (<span class="math inline">\(S_0\)</span>), Latent (<span class="math inline">\(E_0\)</span>), Infected (<span class="math inline">\(I\)</span>), and Recovered (<span class="math inline">\(R\)</span>) compartments. We have initialised the model as an early stage epidemic with a single case of TB.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inits =<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">S =</span> <span class="dv">999</span>,
  <span class="dt">E =</span> <span class="dv">0</span>,
  <span class="dt">I =</span> <span class="dv">1</span>,
  <span class="dt">R =</span> <span class="dv">0</span>
)</code></pre></div>
</div>
<div id="parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h3>
<p>We then specify the model parameters (with the units being years<sup>-1</sup>), varying these parameters will impact the model dynamics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">parameters &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">beta =</span> <span class="dv">3</span>, <span class="co"># Rate of transmission</span>
  <span class="dt">gamma =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>, <span class="co"># Rate of progression to active symptoms </span>
  <span class="dt">tau =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="co"># Rate of recovery</span>
  <span class="dt">mu =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">81</span> <span class="co"># Rate of natural mortality</span>
)</code></pre></div>
</div>
<div id="equations" class="section level3">
<h3 class="hasAnchor">
<a href="#equations" class="anchor"></a>Equations</h3>
<p>Finally we specify the model equations for each population compartment. This model incorporates simple demographic processes with a constant natural death rate from all compartments which is equal to the birth rate into the susceptible compartment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SEIR_demo_ode &lt;-<span class="st"> </span><span class="cf">function</span>(t, x, params) {

  ## Specify model compartments
  S &lt;-<span class="st"> </span>x[<span class="dv">1</span>]
  E &lt;-<span class="st"> </span>x[<span class="dv">2</span>]
  I &lt;-<span class="st"> </span>x[<span class="dv">3</span>]
  R &lt;-<span class="st"> </span>x[<span class="dv">4</span>]

  <span class="kw">with</span>(<span class="kw">as.list</span>(params),{

    ## Specify total population
    N =<span class="st"> </span>S <span class="op">+</span><span class="st"> </span>E <span class="op">+</span><span class="st"> </span>I <span class="op">+</span><span class="st"> </span>R

    ## Derivative Expressions
    dS =<span class="st"> </span><span class="op">-</span>beta <span class="op">*</span><span class="st"> </span>S <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>S <span class="op">+</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>N
    dE =<span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>S <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">-</span><span class="st"> </span>gamma <span class="op">*</span><span class="st"> </span>E <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>E
    dI =<span class="st"> </span>gamma <span class="op">*</span><span class="st"> </span>E <span class="op">-</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>I
    dR =<span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>R

    ## output
    derivatives &lt;-<span class="st"> </span><span class="kw">c</span>(dS, dE, dI, dR)

    <span class="kw">list</span>(derivatives)
  })
}</code></pre></div>
</div>
<div id="simulate-and-summarise" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-and-summarise" class="anchor"></a>Simulate and Summarise</h3>
<p>To simulate the model we specify the starting year (<code>begin_time</code>) and final year (<code>end_time</code>) and define a sequence over all intervening years. The model is then solved using <code><a href="http://www.rdocumentation.org/packages/deSolve/topics/lsoda">deSolve::lsoda</a></code> which is used within a simple wrapper function (see <code><a href="../reference/solve_ode.html">?solve_ode</a></code> for details). The resulting table summarises the simulation results for the first 5 years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">begin_time &lt;-<span class="st"> </span><span class="dv">0</span>
end_time &lt;-<span class="st"> </span><span class="dv">200</span>
times &lt;-<span class="st"> </span><span class="kw">seq</span>(begin_time, end_time, <span class="dv">1</span>)

## see ?solve_ode for details
SEIR_sim &lt;-<span class="st"> </span>biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/solve_ode.html">solve_ode</a></span>(<span class="dt">model =</span> SEIR_demo_ode, 
                                           <span class="dt">inits =</span> inits, 
                                           <span class="dt">params =</span> parameters,
                                           <span class="dt">times =</span> times, 
                                           <span class="dt">as.data.frame =</span> <span class="ot">TRUE</span>)
SEIR_sim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>head <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"First 5 years of model simulation"</span>,
               <span class="dt">label =</span> <span class="st">"tab-1"</span>)</code></pre></div>
<table style="width:57%;" class="table">
<caption>Table 1: First 5 years of model simulation</caption>
<colgroup>
<col width="9%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="center">time</th>
<th align="center">S</th>
<th align="center">E</th>
<th align="center">I</th>
<th align="center">R</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">999</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">996.5</td>
<td align="center">2.306</td>
<td align="center">0.8082</td>
<td align="center">0.4264</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">993.9</td>
<td align="center">4.253</td>
<td align="center">1.008</td>
<td align="center">0.8608</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">990.4</td>
<td align="center">6.724</td>
<td align="center">1.468</td>
<td align="center">1.455</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">985.1</td>
<td align="center">10.32</td>
<td align="center">2.219</td>
<td align="center">2.34</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">977.2</td>
<td align="center">15.71</td>
<td align="center">3.373</td>
<td align="center">3.681</td>
</tr>
</tbody>
</table>
<p>We then summarise the epidemic peak (<code>epi_peak</code>) and epidemic duration (<code>epi_dur</code>), along with population sizes at the end of the time period simulated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/summarise_model.html">summarise_model</a></span>(SEIR_sim) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"SEIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic"</span>)</code></pre></div>
<table style="width:89%;" class="table">
<caption>Table 2: SEIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic (continued below)</caption>
<colgroup>
<col width="22%">
<col width="22%">
<col width="22%">
<col width="22%">
</colgroup>
<thead><tr class="header">
<th align="center">Final size: S</th>
<th align="center">Final size: E</th>
<th align="center">Final size: I</th>
<th align="center">Final size: R</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">181</td>
<td align="center">47</td>
<td align="center">18</td>
<td align="center">753</td>
</tr></tbody>
</table>
<table style="width:78%;" class="table">
<colgroup>
<col width="29%">
<col width="22%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="center">Epidemic peak time</th>
<th align="center">Epidemic peak</th>
<th align="center">Epidemic duration</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">18</td>
<td align="center">141</td>
<td align="center">1</td>
</tr></tbody>
</table>
<p>Finally we plot the population in each model compartment over time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## For an interactive graph change interactive to TRUE
biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/plot_model.html">plot_model</a></span>(SEIR_sim, <span class="dt">interactive =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="solutions_2_files/figure-html/seir-plot-1.png" alt="Figure 2: Plot of population over time in each SEIR model compartment" width="2310"><p class="caption">
Figure 2: Plot of population over time in each SEIR model compartment
</p>
</div>
</div>
<div id="explore" class="section level3">
<h3 class="hasAnchor">
<a href="#explore" class="anchor"></a>Explore</h3>
<p>Model dynamics are parameter dependent. Even in a simplistic model like the one outlined above parameter values can greatly alter the dynamics. Answer the following questions by varying the parameters above and rerunning the model.</p>
<ol style="list-style-type: decimal">
<li>
<p>What is the impact of adding demographic processes (births and deaths)?</p>
<ul>
<li>Without demograpic processes Tuberculosis eventually dies out. The addition of demographic processes results in a continous supply of susceptibles that makes this less likely to happen. However if the disease is sufficiently infectious and has a short serial interval then even with demographic processes the supply of new susceptibles may run out, resulting in the disease dieing out.</li>
</ul>
</li>
<li>
<p>What happens when the transmission rate (beta) is reduced to 0.5?</p>
<ul>
<li>When the transmission rate is reduced to 0.5 Tuberculosis will die out without spreading any further than the index case. This is because the basic reproduction number is below 1 for this set of parameters.</li>
</ul>
</li>
<li>
<p>What happens as the rate of recovery is increased?</p>
<ul>
<li>As the rate of recovery is increased the size of the epidemic peak is decreased and the duration of the epidemic increases. The cumulative number of cases is reduced.</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
<div id="extensions" class="section level1">
<h1 class="hasAnchor">
<a href="#extensions" class="anchor"></a>Extensions</h1>
<div id="explore-the-parameter-space-of-multiple-models" class="section level2">
<h2 class="hasAnchor">
<a href="#explore-the-parameter-space-of-multiple-models" class="anchor"></a>1. Explore the Parameter Space of Multiple Models</h2>
<p>In order to more systematically explore the parameter space of multiple models we have provided a web app (<a href="http://seabbs.co.uk/shiny/exploreidmodels/" class="uri">http://seabbs.co.uk/shiny/exploreidmodels/</a>). Use this to explore the models discussed in the previous practical and identify which parameters alter the model dynamics. What commonalities are there between different models and what generalisations can you draw from this. Try and answer the questions for the other extensions using the models provided in the web app.</p>
<div id="using-the-web-app" class="section level3">
<h3 class="hasAnchor">
<a href="#using-the-web-app" class="anchor"></a>Using the Web App</h3>
<ul>
<li>Go to <a href="http://seabbs.co.uk/shiny/exploreidmodels/" class="uri">http://seabbs.co.uk/shiny/exploreidmodels/</a>. You should see the following:</li>
</ul>
<div class="figure">
<img src="resources/menu-explore-id.png" alt="Figure 3: Homepage for the Explore Infectious Disease web app."><p class="caption">Figure 3: Homepage for the Explore Infectious Disease web app.</p>
</div>
<ul>
<li>Click on the Explore Model Dynamics tab in the menu on the left hand side. The app will now look like this:</li>
</ul>
<div class="figure">
<img src="resources/mod-dyn-explore-id.png" alt="Figure 4: Explore Model Dynamics tab for the Explore Infectious Disease web app."><p class="caption">Figure 4: Explore Model Dynamics tab for the Explore Infectious Disease web app.</p>
</div>
<ul>
<li>Select a model of interest from the menu, options include: SI, SEI, SEIR, and SHLIR, with or without demographic processes.</li>
</ul>
<div class="figure">
<img src="resources/sel-model-explore-id.png" alt="Figure 5: Select a model in the Explore Infectious Disease web app."><p class="caption">Figure 5: Select a model in the Explore Infectious Disease web app.</p>
</div>
<ul>
<li>Now vary parameter values using the provided sliders in the menu, you should observe the population in each compartment changing over time. Both summary tables used in the exercises above are also provided.</li>
</ul>
<div class="figure">
<img src="resources/param-explore-id.png" alt="Figure 6: Vary parameters to explore dynamics in the Explore Infectious Disease web app."><p class="caption">Figure 6: Vary parameters to explore dynamics in the Explore Infectious Disease web app.</p>
</div>
<ul>
<li>Model code is provided under the code tab.</li>
</ul>
<div class="figure">
<img src="resources/model-code.png" alt="Figure 6: Vary parameters to explore dynamics in the Explore Infectious Disease web app."><p class="caption">Figure 6: Vary parameters to explore dynamics in the Explore Infectious Disease web app.</p>
</div>
</div>
</div>
<div id="add-high-and-low-risk-compartments" class="section level2">
<h2 class="hasAnchor">
<a href="#add-high-and-low-risk-compartments" class="anchor"></a>2. Add High and Low Risk Compartments</h2>
<p>To make the SEIR model slightly more realistic, and therefore better able to capture the observed dynamics of TB, we are going to add a second latent population (as discussed in the solutions for practical 1). This change can be seen in the model flow diagram (Figure 7). Go back to <a href="https://bristolmathmodellers.github.io/biddmodellingcourse/articles/practical_1.html">practical 1</a> if you need a refresher for the motivation behind this. We have also added reinfection for the low risk latent population.</p>
<div class="figure">
<img src="resources/SHLIR_flow_diag.png" alt="Figure 7: An SHLIR model of TB transmission, including simple demographic processes"><p class="caption">Figure 7: An SHLIR model of TB transmission, including simple demographic processes</p>
</div>
<div id="populations-and-initialisation-1" class="section level3">
<h3 class="hasAnchor">
<a href="#populations-and-initialisation-1" class="anchor"></a>Populations and Initialisation</h3>
<p>As in the previous model the first step is to define the model populations. There are now two new compartments, high risk latents (H), and low risk latents (L). These replace the original latent population (E) used in the SEIR model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SHLIR_inits =<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">S =</span> <span class="dv">999</span>,
  <span class="dt">H =</span> <span class="dv">0</span>,
  <span class="dt">L =</span> <span class="dv">0</span>,
  <span class="dt">I =</span> <span class="dv">1</span>,
  <span class="dt">R =</span> <span class="dv">0</span>
)</code></pre></div>
</div>
<div id="parameters-1" class="section level3">
<h3 class="hasAnchor">
<a href="#parameters-1" class="anchor"></a>Parameters</h3>
<p>We add two additional parameters for the rate of progression from high to low risk latents (<code>nu</code>) and the rate of progression from low risk latent to active disease (<code>gamma_L</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SHLIR_parameters &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">beta =</span> <span class="dv">3</span>, <span class="co"># Rate of transmission</span>
  <span class="dt">gamma_H =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>, <span class="co"># Rate of progression to active symptoms from high risk latent</span>
  <span class="dt">nu =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="co">#Rate of progression from high to low risk latent</span>
  <span class="dt">gamma_L =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="co"># Rate of progression to active symptoms for low risk latent</span>
  <span class="dt">tau =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="co"># Rate of recovery</span>
  <span class="dt">mu =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">81</span> <span class="co"># Rate of natural mortality</span>
)</code></pre></div>
</div>
<div id="equations-1" class="section level3">
<h3 class="hasAnchor">
<a href="#equations-1" class="anchor"></a>Equations</h3>
<p>The code below is a starting point, fill in the missing model terms using the model flow diagram (Figure 7) and the code for the previous SEIR model as reference points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">SHLIR_demo_ode &lt;-<span class="st"> </span><span class="cf">function</span>(t, x, params) {

  ## Specify model compartments
  S &lt;-<span class="st"> </span>x[<span class="dv">1</span>]
  H &lt;-<span class="st"> </span>x[<span class="dv">2</span>]
  L &lt;-<span class="st"> </span>x[<span class="dv">3</span>]
  I &lt;-<span class="st"> </span>x[<span class="dv">4</span>]
  R &lt;-<span class="st"> </span>x[<span class="dv">5</span>]

  <span class="kw">with</span>(<span class="kw">as.list</span>(params),{

    ## Specify total population
    N =<span class="st"> </span>S <span class="op">+</span><span class="st"> </span>H <span class="op">+</span><span class="st"> </span>L <span class="op">+</span><span class="st"> </span>I <span class="op">+</span><span class="st"> </span>R

    ## Derivative Expressions
    dS =<span class="st"> </span><span class="op">-</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>S <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>S <span class="op">+</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>N
    ## These are the new equations - fill in the remaining terms
    dH =<span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>(S <span class="op">+</span><span class="st"> </span>L) <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">-</span><span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>H
    dL =<span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>L <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">-</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>L
    ## Hint terms are missing from this equation as well
    dI =<span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H <span class="op">+</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L <span class="op">-</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>I
    dR =<span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>R

    ## output
    derivatives &lt;-<span class="st"> </span><span class="kw">c</span>(dS, dH, dL, dI, dR)

    <span class="kw">list</span>(derivatives)
  })
}</code></pre></div>
</div>
<div id="simulate-and-summarise-1" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-and-summarise-1" class="anchor"></a>Simulate and Summarise</h3>
<p>Simulation is the same as for the previous model. Does the simulation of your improved model make sense? Evaluate the summary tables and plot of model populations over time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">begin_time &lt;-<span class="st"> </span><span class="dv">0</span>
end_time &lt;-<span class="st"> </span><span class="dv">200</span>
SHILR_times &lt;-<span class="st"> </span><span class="kw">seq</span>(begin_time, end_time, <span class="dv">1</span>)

## see ?solve_ode for details
SHLIR_sim &lt;-<span class="st"> </span>biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/solve_ode.html">solve_ode</a></span>(<span class="dt">model =</span> SHLIR_demo_ode, 
                                           <span class="dt">inits =</span> SHLIR_inits, 
                                           <span class="dt">params =</span> SHLIR_parameters,
                                           <span class="dt">times =</span> SHILR_times, 
                                           <span class="dt">as.data.frame =</span> <span class="ot">TRUE</span>)
SHLIR_sim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>head <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"First 5 years of SHLIR model simulation"</span>,
               <span class="dt">label =</span> <span class="st">"tab-1"</span>)</code></pre></div>
<table style="width:69%;" class="table">
<caption>Table 1: First 5 years of model simulation</caption>
<colgroup>
<col width="9%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="center">time</th>
<th align="center">S</th>
<th align="center">H</th>
<th align="center">L</th>
<th align="center">I</th>
<th align="center">R</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">999</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">996.5</td>
<td align="center">1.794</td>
<td align="center">0.5224</td>
<td align="center">0.7773</td>
<td align="center">0.4223</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">994.2</td>
<td align="center">2.576</td>
<td align="center">1.606</td>
<td align="center">0.8263</td>
<td align="center">0.8098</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">991.6</td>
<td align="center">3.186</td>
<td align="center">2.99</td>
<td align="center">0.9684</td>
<td align="center">1.243</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">988.6</td>
<td align="center">3.853</td>
<td align="center">4.648</td>
<td align="center">1.164</td>
<td align="center">1.756</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">984.9</td>
<td align="center">4.653</td>
<td align="center">6.621</td>
<td align="center">1.411</td>
<td align="center">2.372</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/summarise_model.html">summarise_model</a></span>(SHLIR_sim) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"SHLIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic"</span>)</code></pre></div>
<table class="table">
<caption>Table 3: SHLIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic (continued below)</caption>
<colgroup>
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th align="center">Final size: S</th>
<th align="center">Final size: H</th>
<th align="center">Final size: L</th>
<th align="center">Final size: I</th>
<th align="center">Final size: R</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">238</td>
<td align="center">24</td>
<td align="center">194</td>
<td align="center">13</td>
<td align="center">531</td>
</tr></tbody>
</table>
<table style="width:78%;" class="table">
<colgroup>
<col width="29%">
<col width="22%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="center">Epidemic peak time</th>
<th align="center">Epidemic peak</th>
<th align="center">Epidemic duration</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">32</td>
<td align="center">57</td>
<td align="center">1</td>
</tr></tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## For an interactive graph change interactive to TRUE
biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/plot_model.html">plot_model</a></span>(SHLIR_sim, <span class="dt">interactive =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="solutions_2_files/figure-html/shlir-plot-1.png" alt="Figure 8: Plot of the population in each SHLIR model compartment over time" width="2310"><p class="caption">
Figure 8: Plot of the population in each SHLIR model compartment over time
</p>
</div>
</div>
<div id="explore-1" class="section level3">
<h3 class="hasAnchor">
<a href="#explore-1" class="anchor"></a>Explore</h3>
<ol style="list-style-type: decimal">
<li>
<p>Test your changes by setting <code>nu = 0</code> and all other parameters to be the same as for the SEIR model. If everything is working correctly both models should give the same output.</p>
<ul>
<li>The SEIR and SHLIR models should give the same result.</li>
<li>This works because when <code>nu = 0</code> no one enters the low risk latent population compartment and therefore it has no effect.</li>
</ul>
</li>
<li>
<p>What has the impact of adding the second latent population been?</p>
<ul>
<li>It has reduced the peak epidemic size and slowed the initial spread of the disease. In addition there are fewer cumulative active cases but a larger pool of latently infected cases.</li>
</ul>
</li>
</ol>
</div>
</div>
<div id="translate-a-more-realistic-shlir-model-flow-diagram-to-equations" class="section level2">
<h2 class="hasAnchor">
<a href="#translate-a-more-realistic-shlir-model-flow-diagram-to-equations" class="anchor"></a>3. Translate a more realistic SHLIR model flow diagram to equations</h2>
<p>As an advanced extension exercise now translate a more complex SHLIR model flow diagram (Figure 9), with risk groups, treatment, and reinfection for those who have recovered from active disease (Hint: First implement the model without risk groups and then add this in once everything else is working as expected). Whilst many realistic TB models use age structure in the interests of time do not include this (if you are interested in discussing how you would include this talk to your instructors or contact <a href="https://www.samabbott.co.uk/">me</a>). For the motivation behind this model see <a href="https://bristolmathmodellers.github.io/biddmodellingcourse/articles/practical_1.html">practical 1</a>.</p>
<div class="figure">
<img src="resources/SHLIR_real_flow_diag.png" alt="Figure 9: A realistic SHLIR model of TB transmission, including simple demographic processes"><p class="caption">Figure 9: A realistic SHLIR model of TB transmission, including simple demographic processes</p>
</div>
<p>Figure 9 does not include the interaction between the high and low risk subgroups as this is through the force of infection. The force of infection is defined as,</p>
<p><span class="math display">\[ \lambda_i = \beta \sum_{j = L, H}M_{ij}I_j \]</span></p>
<p>Where <span class="math inline">\(\lambda_i\)</span> is the force of infection in each risk group (<span class="math inline">\(i = L, H\)</span>) and <span class="math inline">\(M_{LH}\)</span> is the mixing rate between risk groups. It is assumed that within group contact rates are equivalent and defined such that,</p>
<p><span class="math display">\[ M_{ii} = 1 \]</span></p>
<p>It is also assumed that the between group contact rates are defined as (where <span class="math inline">\(i \neq j\)</span>),</p>
<p><span class="math display">\[ M_{ij} = 0.1 \]</span></p>
<p>The code for an SEIR model has been supplied, along with all the required simulation and plotting functions. It is suggested that you add complexity sequentially and test the effects on the model dynamics as you go. The first step is to recreate the SHLIR model used above. If you are new to <code>R</code> or are struggling with this exercise feel free to move on to the next exercise (which does not use <code>R</code>).</p>
<div id="populations-and-initialisation-2" class="section level3">
<h3 class="hasAnchor">
<a href="#populations-and-initialisation-2" class="anchor"></a>Populations and Initialisation</h3>
<p>The new populations have been added for you. The population has now been split between low and high risk populations, with the only infectious case being in the high risk population.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">real_SHLIR_inits =<span class="st"> </span><span class="kw">c</span>(
  <span class="co"># General population</span>
  <span class="dt">S =</span> <span class="dv">800</span>,
  <span class="dt">H =</span> <span class="dv">0</span>,
  <span class="dt">L =</span> <span class="dv">0</span>,
  <span class="dt">I =</span> <span class="dv">0</span>,
  <span class="dt">Tr =</span> <span class="dv">0</span>,
  <span class="dt">R =</span> <span class="dv">0</span>,
  ## High risk population
  <span class="dt">S_H =</span> <span class="dv">199</span>,
  <span class="dt">H_H =</span> <span class="dv">0</span>,
  <span class="dt">L_H =</span> <span class="dv">0</span>,
  <span class="dt">I_H =</span> <span class="dv">1</span>,
  <span class="dt">Tr_H =</span> <span class="dv">0</span>,
  <span class="dt">R_H =</span> <span class="dv">0</span>
)</code></pre></div>
</div>
<div id="parameters-2" class="section level3">
<h3 class="hasAnchor">
<a href="#parameters-2" class="anchor"></a>Parameters</h3>
<p>The required model parameters have been defined for you (with the units being years<sup>-1</sup>). The only new parameters are the between group mixing (<code>M</code>), the proportion that are born high risk (<code>p</code>), and the transmission probability in those considered to be high risk (<code>beta_H</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">real_SHLIR_parameters &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">beta =</span> <span class="dv">3</span>, <span class="co"># Rate of transmission</span>
  <span class="dt">beta_H =</span> <span class="dv">6</span>, <span class="co"># High risk rate of transmission</span>
  <span class="dt">gamma_H =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>, <span class="co"># Rate of progression to active symptoms from high risk latent</span>
  <span class="dt">nu =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="co">#Rate of progression from high to low risk latent</span>
  <span class="dt">gamma_L =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="co"># Rate of progression to active symptoms for low risk latent</span>
  <span class="dt">epsilon =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>, <span class="co"># Rate of treatment</span>
  <span class="dt">tau =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="co"># Rate of recovery</span>
  <span class="dt">mu =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">81</span>, <span class="co"># Rate of natural mortality</span>
  <span class="dt">p =</span> <span class="fl">0.2</span>, <span class="co"># proportion of new births that are high risk</span>
  <span class="dt">M =</span> <span class="fl">0.2</span> <span class="co"># Between group mixing</span>
)</code></pre></div>
</div>
<div id="equations-2" class="section level3">
<h3 class="hasAnchor">
<a href="#equations-2" class="anchor"></a>Equations</h3>
<p>Update the model equations using the model flow diagram above. The comments in the code given hints as to where changes need to be made. The equations for the low risk population have been provided for you.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">real_SHLIR_demo_ode &lt;-<span class="st"> </span><span class="cf">function</span>(t, x, params) {

  ## Specify model compartments 
  ## The compartments for the low risk population have been provided 
  ## Add the high risk population
  ## Don't forget to update indexing for x. Compare the previous two models for a hint.
  S &lt;-<span class="st"> </span>x[<span class="dv">1</span>]
  H &lt;-<span class="st"> </span>x[<span class="dv">2</span>]
  L &lt;-<span class="st"> </span>x[<span class="dv">3</span>]
  I &lt;-<span class="st"> </span>x[<span class="dv">4</span>]
  Tr &lt;-<span class="st"> </span>x[<span class="dv">5</span>]
  R &lt;-<span class="st"> </span>x[<span class="dv">6</span>]
  
  S_H &lt;-<span class="st"> </span>x[<span class="dv">7</span>]
  H_H &lt;-<span class="st"> </span>x[<span class="dv">8</span>]
  L_H &lt;-<span class="st"> </span>x[<span class="dv">9</span>]
  I_H &lt;-<span class="st"> </span>x[<span class="dv">10</span>]
  Tr_H &lt;-<span class="st"> </span>x[<span class="dv">11</span>]
  R_H &lt;-<span class="st"> </span>x[<span class="dv">12</span>]

  <span class="kw">with</span>(<span class="kw">as.list</span>(params),{

    ## Specify total population
    N =<span class="st"> </span>S <span class="op">+</span><span class="st"> </span>H <span class="op">+</span><span class="st"> </span>L <span class="op">+</span><span class="st"> </span>I <span class="op">+</span><span class="st"> </span>Tr <span class="op">+</span><span class="st"> </span>R <span class="op">+</span><span class="st"> </span>S_H <span class="op">+</span><span class="st"> </span>H_H <span class="op">+</span><span class="st"> </span>L_H <span class="op">+</span><span class="st"> </span>I_H <span class="op">+</span><span class="st"> </span>Tr_H <span class="op">+</span><span class="st"> </span>R_H

    ## Force of infection
    ## The force of infetion in the low risk population has been provided for you
    foi &lt;-<span class="st"> </span>beta  <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">+</span><span class="st"> </span>M <span class="op">*</span><span class="st"> </span>beta_H <span class="op">*</span><span class="st"> </span>I_H <span class="op">/</span><span class="st"> </span>N 
    ## Add the high risk force of infection here
    foi_H &lt;-<span class="st">  </span>M <span class="op">*</span><span class="st"> </span>beta  <span class="op">*</span><span class="st"> </span>I <span class="op">/</span><span class="st"> </span>N <span class="op">+</span><span class="st">  </span>beta_H <span class="op">*</span><span class="st"> </span>I_H <span class="op">/</span><span class="st"> </span>N 
    
    ## Derivative Expressions
    ## General population - provided for you
    ## Compare these equations from those used for the previous models
    dS =<span class="st"> </span><span class="op">-</span>S <span class="op">*</span><span class="st"> </span>foi <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>S <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p) <span class="op">*</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>N
    dH =<span class="st"> </span>(S <span class="op">+</span><span class="st"> </span>L <span class="op">+</span><span class="st"> </span>R) <span class="op">*</span><span class="st"> </span>foi <span class="op">-</span><span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>H
    dL =<span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H <span class="op">-</span><span class="st"> </span>L <span class="op">*</span><span class="st"> </span>foi <span class="op">-</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>L
    dI =<span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H <span class="op">+</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L <span class="op">-</span><span class="st"> </span>epsilon <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>I
    dTr =<span class="st"> </span>epsilon <span class="op">*</span><span class="st"> </span>I <span class="op">-</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>Tr <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>Tr
    dR =<span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>Tr <span class="op">-</span><span class="st"> </span>R <span class="op">*</span><span class="st"> </span>foi <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>R
    
    ## High risk population
    ## Copy the equations used above for the low risk population
    ## Convert them to be in the high risk population
    dS_H =<span class="st"> </span><span class="op">-</span>S_H <span class="op">*</span><span class="st"> </span>foi_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>S_H <span class="op">+</span><span class="st"> </span>p <span class="op">*</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>N
    dH_H =<span class="st"> </span>(S_H <span class="op">+</span><span class="st"> </span>L_H <span class="op">+</span><span class="st"> </span>R_H) <span class="op">*</span><span class="st"> </span>foi_H <span class="op">-</span><span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H_H <span class="op">-</span><span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>H_H
    dL_H =<span class="st"> </span>nu <span class="op">*</span><span class="st"> </span>H_H <span class="op">-</span><span class="st"> </span>L_H <span class="op">*</span><span class="st"> </span>foi_H <span class="op">-</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>L_H
    dI_H =<span class="st"> </span>gamma_H <span class="op">*</span><span class="st"> </span>H_H <span class="op">+</span><span class="st"> </span>gamma_L <span class="op">*</span><span class="st"> </span>L_H <span class="op">-</span><span class="st"> </span>epsilon <span class="op">*</span><span class="st"> </span>I_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>I_H
    dTr_H =<span class="st"> </span>epsilon <span class="op">*</span><span class="st"> </span>I_H <span class="op">-</span><span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>Tr_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>Tr_H
    dR_H =<span class="st"> </span>tau <span class="op">*</span><span class="st"> </span>Tr_H <span class="op">-</span><span class="st"> </span>R_H <span class="op">*</span><span class="st"> </span>foi_H <span class="op">-</span><span class="st"> </span>mu <span class="op">*</span><span class="st"> </span>R_H

    ## output
    derivatives &lt;-<span class="st"> </span><span class="kw">c</span>(dS, dH, dL, dI, dTr, dR, dS_H, dH_H, dL_H, dI_H, dTr_H, dR_H)

    <span class="kw">list</span>(derivatives)
  })
}</code></pre></div>
</div>
<div id="simulate-and-summarise-2" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-and-summarise-2" class="anchor"></a>Simulate and Summarise</h3>
<p>Simulate the new model as previously.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">begin_time &lt;-<span class="st"> </span><span class="dv">0</span>
end_time &lt;-<span class="st"> </span><span class="dv">200</span>
real_SHLIR_times &lt;-<span class="st"> </span><span class="kw">seq</span>(begin_time, end_time, <span class="dv">1</span>)

## see ?solve_ode for details
real_SHLIR_sim &lt;-<span class="st"> </span>biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/solve_ode.html">solve_ode</a></span>(<span class="dt">model =</span> real_SHLIR_demo_ode, 
                                           <span class="dt">inits =</span> real_SHLIR_inits, 
                                           <span class="dt">params =</span> real_SHLIR_parameters,
                                           <span class="dt">times =</span> real_SHLIR_times, 
                                           <span class="dt">as.data.frame =</span> <span class="ot">TRUE</span>)
real_SHLIR_sim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>head <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"First 5 years of model simulation"</span>,
               <span class="dt">label =</span> <span class="st">"tab-real_SHLIR"</span>)</code></pre></div>
<table style="width:100%;" class="table">
<caption>Table 4: First 5 years of model simulation (continued below)</caption>
<colgroup>
<col width="9%">
<col width="10%">
<col width="12%">
<col width="12%">
<col width="13%">
<col width="15%">
<col width="16%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="center">time</th>
<th align="center">S</th>
<th align="center">H</th>
<th align="center">L</th>
<th align="center">I</th>
<th align="center">Tr</th>
<th align="center">R</th>
<th align="center">S_H</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">800</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">199</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">799.1</td>
<td align="center">0.6388</td>
<td align="center">0.1786</td>
<td align="center">0.06452</td>
<td align="center">0.006904</td>
<td align="center">0.0009364</td>
<td align="center">198</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">798.1</td>
<td align="center">1.048</td>
<td align="center">0.5935</td>
<td align="center">0.1941</td>
<td align="center">0.03844</td>
<td align="center">0.01108</td>
<td align="center">197.1</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">796.8</td>
<td align="center">1.477</td>
<td align="center">1.201</td>
<td align="center">0.3596</td>
<td align="center">0.09632</td>
<td align="center">0.04336</td>
<td align="center">196.3</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">795.1</td>
<td align="center">2.002</td>
<td align="center">2.027</td>
<td align="center">0.5632</td>
<td align="center">0.1794</td>
<td align="center">0.1102</td>
<td align="center">195.5</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">792.9</td>
<td align="center">2.658</td>
<td align="center">3.121</td>
<td align="center">0.8155</td>
<td align="center">0.2889</td>
<td align="center">0.2236</td>
<td align="center">194.6</td>
</tr>
</tbody>
</table>
<table style="width:62%;" class="table">
<colgroup>
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="center">H_H</th>
<th align="center">L_H</th>
<th align="center">I_H</th>
<th align="center">Tr_H</th>
<th align="center">R_H</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">0.7367</td>
<td align="center">0.2138</td>
<td align="center">0.785</td>
<td align="center">0.2257</td>
<td align="center">0.06372</td>
</tr>
<tr class="odd">
<td align="center">0.9991</td>
<td align="center">0.6472</td>
<td align="center">0.7108</td>
<td align="center">0.3277</td>
<td align="center">0.2031</td>
</tr>
<tr class="even">
<td align="center">1.106</td>
<td align="center">1.153</td>
<td align="center">0.6904</td>
<td align="center">0.3781</td>
<td align="center">0.3761</td>
</tr>
<tr class="odd">
<td align="center">1.169</td>
<td align="center">1.684</td>
<td align="center">0.6935</td>
<td align="center">0.4067</td>
<td align="center">0.565</td>
</tr>
<tr class="even">
<td align="center">1.228</td>
<td align="center">2.23</td>
<td align="center">0.7103</td>
<td align="center">0.4267</td>
<td align="center">0.7623</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/summarise_model.html">summarise_model</a></span>(real_SHLIR_sim) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/prettypublisher/topics/pretty_table">pretty_table</a></span>(<span class="dt">caption =</span> <span class="st">"Realistic SHLIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic"</span>)</code></pre></div>
<table class="table">
<caption>Table 5: Realistic SHLIR model summary statistics; The final size of each population at the end of the simulation, along with the time the epidemic peak was reached, the number of infected at the epidemic peak and the duration of the epidemic (continued below)</caption>
<colgroup>
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th align="center">Final size: S</th>
<th align="center">Final size: H</th>
<th align="center">Final size: L</th>
<th align="center">Final size: I</th>
<th align="center">Final size: Tr</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">22</td>
<td align="center">218</td>
<td align="center">242</td>
<td align="center">133</td>
<td align="center">87</td>
</tr></tbody>
</table>
<table style="width:97%;" class="table">
<caption>Table continues below</caption>
<colgroup>
<col width="22%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center">Final size: R</th>
<th align="center">Final size: S_H</th>
<th align="center">Final size: H_H</th>
<th align="center">Final size: L_H</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">98</td>
<td align="center">10</td>
<td align="center">39</td>
<td align="center">77</td>
</tr></tbody>
</table>
<table class="table">
<caption>Table continues below</caption>
<colgroup>
<col width="24%">
<col width="25%">
<col width="24%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="center">Final size: I_H</th>
<th align="center">Final size: Tr_H</th>
<th align="center">Final size: R_H</th>
<th align="center">Epidemic peak time</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">25</td>
<td align="center">16</td>
<td align="center">33</td>
<td align="center">74</td>
</tr></tbody>
</table>
<table style="width:49%;" class="table">
<colgroup>
<col width="22%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="center">Epidemic peak</th>
<th align="center">Epidemic duration</th>
</tr></thead>
<tbody><tr class="odd">
<td align="center">133</td>
<td align="center">0</td>
</tr></tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## For an interactive graph change interactive to TRUE
biddmodellingcourse<span class="op">::</span><span class="kw"><a href="https://bristolmathmodellers.github.io/biddmodellingcourse//reference/plot_model.html">plot_model</a></span>(real_SHLIR_sim, <span class="dt">interactive =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="solutions_2_files/figure-html/real-SHLIR-plot-1.png" alt="Figure 10: Plot of population over time in each realistic SHLIR model compartment" width="2310"><p class="caption">
Figure 10: Plot of population over time in each realistic SHLIR model compartment
</p>
</div>
</div>
<div id="explore-2" class="section level3">
<h3 class="hasAnchor">
<a href="#explore-2" class="anchor"></a>Explore</h3>
<ol style="list-style-type: decimal">
<li>
<p>Test your changes by setting all the parameters to be the same as in the SHLIR model.</p>
<ul>
<li>The models should give the same results.</li>
</ul>
</li>
<li>
<p>What happens when one group has a much higher transmission probability (use the default settings for all other parameters), compared to when the transmission probability is the same for both groups?</p>
<ul>
<li>The proportion of cases that are in the high risk latent and infectious populations has increased.</li>
</ul>
</li>
<li>
<p>What is the impact of varying the mixing between high and low risk groups for the above scenario?</p>
<ul>
<li>As mixing is reduced the proportion of the low risk population that are infected is reduced.</li>
<li>As mixing is increased the disease dynamics become more homogeneous between groups.</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Brooks-Pollock2010">
<p>1 Brooks-Pollock E, Cohen T, Murray M. The impact of realistic age structure in simple models of tuberculosis transmission. <em>PLoS One</em> 2010;<strong>5</strong>:3â€“8. doi:<a href="https://doi.org/10.1371/journal.pone.0008479">10.1371/journal.pone.0008479</a></p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#learning-objectives">Learning Objectives</a></li>
      <li><a href="#outline-for-session">Outline for Session</a></li>
      <li>
<a href="#exercise">Exercise</a><ul class="nav nav-pills nav-stacked">
<li><a href="#a-simple-seir-model-of-tuberculosis-tb">1. A Simple SEIR Model of Tuberculosis (TB)</a></li>
      </ul>
</li>
      <li>
<a href="#extensions">Extensions</a><ul class="nav nav-pills nav-stacked">
<li><a href="#explore-the-parameter-space-of-multiple-models">1. Explore the Parameter Space of Multiple Models</a></li>
      <li><a href="#add-high-and-low-risk-compartments">2. Add High and Low Risk Compartments</a></li>
      <li><a href="#translate-a-more-realistic-shlir-model-flow-diagram-to-equations">3. Translate a more realistic SHLIR model flow diagram to equations</a></li>
      </ul>
</li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Sam Abbott, Josephine Walker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
